#' Get transmitter metadata
#'
#' Get the metadata about the transmitter tags. At the moment, only transmitters
#' that can be linked to a projectcode are returned to the user. By default,
#' only animal tags are returned.
#'
#' @param connection A valid connection with the ETN database.
#' @param animal_project (string) One or more animal projects.
#' @param include_reference_tags (logical) Include reference tags (not-animal
#'   tags). Default: FALSE.
#'
#' @return A tibble (tidyverse data.frame).
#'
#' @export
#'
#' @importFrom glue glue_sql
#' @importFrom DBI dbGetQuery
#' @importFrom dplyr pull %>%
#' @importFrom rlang .data
#' @importFrom tibble as_tibble
#'
#' @examples
#' \dontrun{
#' con <- connect_to_etn(your_username, your_password)
#'
#' # Get the metadata of all transmitter animal tags
#' get_transmitters(con)
#'
#' # Get the metadata of all transmitter tags
#' get_transmitters(con, include_reference_tags = TRUE)
#'
#' # Get the metadata of the tags linked to specific project(s)
#' get_transmitters(con, animal_project = "phd_reubens")
#' get_transmitters(con, animal_project = c("phd_reubens", "2012_leopoldkanaal"))
#' }
get_transmitters <- function(connection,
                     animal_project = NULL,
                     include_reference_tags = FALSE) {

  check_connection(connection)

  # valid inputs on animal projects
  valid_animals_projects <-
    get_projects(connection, project_type = "animal") %>%
    pull(.data$projectcode)
  check_null_or_value(animal_project,  valid_animals_projects, "animal_project")
  if (is.null(animal_project)) {
    animal_project = valid_animals_projects
  }

  transmitters_query <- glue_sql("
      SELECT tags.*, animals.projectcode, etn_group.name as owner_organization
      FROM vliz.tags
        LEFT JOIN vliz.animal_tag_release ON (animal_tag_release.tag_fk = tags.id_pk)
        LEFT JOIN vliz.animals_view animals ON (animals.id_pk = animal_tag_release.animal_fk)
        LEFT JOIN vliz.etn_group  ON (tags.owner_group_fk = etn_group.id_pk)
      WHERE projectcode IN ({project*})",
                                     project = animal_project,
                                     .con = connection
  )
  transmitters <- dbGetQuery(connection, transmitters_query)

    if (include_reference_tags) {
    transmitters
  } else {
    transmitters %>% filter(.data$acoustic_tag_type == "animal")
  }

  as_tibble(transmitters)

}
